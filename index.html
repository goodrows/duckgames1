<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rocket Dodge Game</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden; background: #111;
    font-family: Arial, sans-serif; color: white;
  }
  #gameArea {
    position: relative;
    width: 100vw; height: 100vh;
    background: linear-gradient(#000022, #000000);
    overflow: hidden;
  }
  #rocket {
    position: absolute;
    bottom: 50px;
    left: calc(50% - 15px);
    width: 30px; height: 30px;
    background: red;
    border-radius: 6px;
    box-shadow: 0 0 10px 3px #f40;
    transition: background 0.3s, border 0.3s;
  }
  .bullet {
    position: absolute;
    width: 20px; height: 20px;
    background: #ccc;
    border-radius: 50%;
    box-shadow: 0 0 5px 1px #ccc;
  }
  .powerup {
    position: absolute;
    width: 22px; height: 22px;
    border-radius: 50%;
    box-shadow: 0 0 8px 2px;
  }
  .shield { background: cyan; box-shadow: 0 0 12px 3px cyan; }
  .double { background: gold; box-shadow: 0 0 12px 3px gold; }
  .speed { background: orange; box-shadow: 0 0 12px 3px orange; }
  .freeze { background: lightblue; box-shadow: 0 0 12px 3px lightblue; }
  .slow { background: purple; box-shadow: 0 0 12px 3px purple; }
  .life { background: pink; box-shadow: 0 0 12px 3px pink; }

  #scoreBoard {
    position: absolute;
    top: 10px; left: 10px;
    font-size: 18px;
  }
  #powerupNotification {
    position: absolute;
    top: 10px;
    left: 50%; transform: translateX(-50%);
    font-size: 22px;
    color: #ff8;
    opacity: 0;
    transition: opacity 0.4s;
    pointer-events: none;
    text-shadow: 0 0 5px black;
  }
  #retryBtn, #pauseBtn {
    position: absolute;
    bottom: 10px;
    padding: 8px 14px;
    font-size: 18px;
    cursor: pointer;
    background: #222;
    color: white;
    border: 1px solid #555;
    border-radius: 5px;
    user-select: none;
  }
  #retryBtn {
    left: 50%; transform: translateX(-50%);
    display: none;
  }
  #pauseBtn {
    right: 10px;
  }

  /* Mobile buttons */
  #leftBtn, #rightBtn {
    position: fixed;
    bottom: 100px;
    width: 40vw;
    height: 60px;
    opacity: 0.4;
    background: #444;
    color: white;
    font-size: 40px;
    text-align: center;
    line-height: 60px;
    user-select: none;
    z-index: 1000;
  }
  #leftBtn { left: 0; border-top-right-radius: 30px; border-bottom-right-radius: 30px; }
  #rightBtn { right: 0; border-top-left-radius: 30px; border-bottom-left-radius: 30px; }

  /* Rocket trail */
  .trail {
    position: absolute;
    width: 8px;
    height: 8px;
    background: orange;
    border-radius: 50%;
    opacity: 0.7;
    pointer-events: none;
    filter: drop-shadow(0 0 4px orange);
    animation: fadeOut 0.6s forwards;
  }
  @keyframes fadeOut {
    to { opacity: 0; transform: translateY(20px); }
  }
</style>
</head>
<body>
  <div id="gameArea">
    <div id="rocket"></div>
    <div id="scoreBoard">Score: 0 | Lives: 3 | Level: 1 | Shield: No</div>
    <div id="powerupNotification"></div>
    <button id="retryBtn">Retry</button>
    <button id="pauseBtn">Pause</button>
    <div id="leftBtn">&#8592;</div>
    <div id="rightBtn">&#8594;</div>
  </div>

  <audio id="bgMusic" loop src="https://cdn.pixabay.com/download/audio/2021/09/09/audio_3c287814ef.mp3?filename=happy-upbeat-pop-13702.mp3"></audio>
  <audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2021/09/21/audio_23e0d91f7e.mp3?filename=game-hit-8028.mp3"></audio>
  <audio id="powerupSound" src="https://cdn.pixabay.com/download/audio/2021/10/21/audio_2a7e51ef4e.mp3?filename=retro-game-powerup-6309.mp3"></audio>

<script>
(() => {
  const gameArea = document.getElementById("gameArea");
  const rocket = document.getElementById("rocket");
  const scoreBoard = document.getElementById("scoreBoard");
  const powerupNotification = document.getElementById("powerupNotification");
  const retryBtn = document.getElementById("retryBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const bgMusic = document.getElementById("bgMusic");
  const hitSound = document.getElementById("hitSound");
  const powerupSound = document.getElementById("powerupSound");

  let bullets = [];
  let powerups = [];
  let score = 0;
  let highScore = localStorage.getItem("highScore") || 0;
  let level = 1;
  let lives = 3;
  let bulletSpeed = 4;
  let rocketSpeed = 10;
  let isPaused = false;
  let leftPressed = false;
  let rightPressed = false;

  let shieldActive = false;
  let doublePointsActive = false;
  let speedBoostActive = false;
  let freezeBulletsActive = false;

  let powerupActive = false;
  let powerupTimer = null;
  let freezeTimeout = null;

  // For spawn timing using timestamps
  let lastSpawnBulletTime = 0;
  let lastSpawnPowerupTime = 0;

  // Show notifications on powerup
  function showPowerupNotification(text) {
    powerupNotification.textContent = text;
    powerupNotification.style.opacity = "1";
    setTimeout(() => {
      powerupNotification.style.opacity = "0";
    }, 2000);
  }

  // Update score, lives, level on screen
  function updateScore() {
    scoreBoard.textContent = `Score: ${score} | Lives: ${lives} | Level: ${level} | Shield: ${shieldActive ? "Yes" : "No"}`;
  }

  // Spawn a bullet at random X top position
  function spawnBullet() {
    if (isPaused) return;

    const b = document.createElement("div");
    b.classList.add("bullet");
    const x = Math.random() * (window.innerWidth - 20);
    b.style.left = x + "px";
    b.style.top = "0px";
    gameArea.appendChild(b);
    bullets.push({ el: b, x, y: 0 });
  }

  // Powerups definitions
  const powerupTypes = [
    {
      name: "Shield",
      class: "shield",
      activate() {
        if (shieldActive) return false;
        shieldActive = true;
        showPowerupNotification("Shield Activated!");
        vibratePattern([200, 100, 200]);
        powerupSound.play();
        if (powerupTimer) clearTimeout(powerupTimer);
        powerupTimer = setTimeout(() => {
          shieldActive = false;
          showPowerupNotification("Shield Ended");
          updateScore();
        }, 8000);
        updateScore();
        return true;
      }
    },
    {
      name: "Double Points",
      class: "double",
      activate() {
        if (doublePointsActive) return false;
        doublePointsActive = true;
        showPowerupNotification("Double Points!");
        vibratePattern([300, 100, 300]);
        powerupSound.play();
        if (powerupTimer) clearTimeout(powerupTimer);
        powerupTimer = setTimeout(() => {
          doublePointsActive = false;
          showPowerupNotification("Double Points Ended");
        }, 7000);
        return true;
      }
    },
    {
      name: "Speed Boost",
      class: "speed",
      activate() {
        if (speedBoostActive) return false;
        speedBoostActive = true;
        rocketSpeed *= 1.5;
        rocket.style.border = "2px solid orange";
        showPowerupNotification("Speed Boost!");
        vibratePattern([200, 200, 100]);
        powerupSound.play();
        if (powerupTimer) clearTimeout(powerupTimer);
        powerupTimer = setTimeout(() => {
          speedBoostActive = false;
          rocketSpeed /= 1.5;
          rocket.style.border = "none";
          showPowerupNotification("Speed Boost Ended");
        }, 5000);
        return true;
      }
    },
    {
      name: "Bullet Freeze",
      class: "freeze",
      activate() {
        if (freezeBulletsActive) return false;
        freezeBulletsActive = true;
        showPowerupNotification("Bullet Freeze!");
        vibratePattern([100, 300, 100]);
        powerupSound.play();
        if (freezeTimeout) clearTimeout(freezeTimeout);
        freezeTimeout = setTimeout(() => {
          freezeBulletsActive = false;
          showPowerupNotification("Bullet Freeze Ended");
        }, 4000);
        return true;
      }
    },
    {
      name: "Slow Bullets",
      class: "slow",
      activate() {
        bulletSpeed /= 2;
        showPowerupNotification("Bullets Slowed!");
        vibratePattern([150, 150]);
        powerupSound.play();
        if (powerupTimer) clearTimeout(powerupTimer);
        powerupTimer = setTimeout(() => {
          bulletSpeed *= 2;
          showPowerupNotification("Bullets Speed Normal");
        }, 6000);
        return true;
      }
    },
    {
      name: "Extra Life",
      class: "life",
      activate() {
        if (lives >= 5) return false;
        lives++;
        showPowerupNotification("Extra Life Gained!");
        vibratePattern([200, 50, 200]);
        powerupSound.play();
        updateScore();
        return true;
      }
    }
  ];

  // Vibrate pattern helper
  function vibratePattern(pattern) {
    if ("vibrate" in navigator) {
      navigator.vibrate(pattern);
    }
  }

  // Spawn powerup randomly
  function spawnPowerup() {
    if (isPaused) return;

    const pu = document.createElement("div");
    const type = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
    pu.classList.add("powerup", type.class);
    pu.style.left = Math.random() * (window.innerWidth - 22) + "px";
    pu.style.top = "0px";
    gameArea.appendChild(pu);
    powerups.push({ el: pu, x: pu.offsetLeft, y: 0, type });

    // No more recursive timeout here, spawn timing handled in gameLoop
  }

  // Check if rectangles intersect for collision
  function rectsIntersect(a, b) {
    return !(
      a.right < b.left ||
      a.left > b.right ||
      a.bottom < b.top ||
      a.top > b.bottom
    );
  }

  // Create a little rocket trail effect
  function createTrail() {
    const trail = document.createElement("div");
    trail.classList.add("trail");
    trail.style.left = (rocket.offsetLeft + rocket.offsetWidth/2 - 4) + "px";
    trail.style.top = (rocket.offsetTop + rocket.offsetHeight - 4) + "px";
    gameArea.appendChild(trail);
    setTimeout(() => trail.remove(), 600);
  }

  // Reset the game
  function resetGame() {
    // Remove bullets & powerups
    bullets.forEach(b => b.el.remove());
    bullets = [];
    powerups.forEach(p => p.el.remove());
    powerups = [];

    score = 0;
    level = 1;
    lives = 3;
    bulletSpeed = 4;
    rocketSpeed = 10;
    shieldActive = false;
    doublePointsActive = false;
    speedBoostActive = false;
    freezeBulletsActive = false;
    updateScore();
    retryBtn.style.display = "none";
    pauseBtn.style.display = "inline-block";
    isPaused = false;
    bgMusic.currentTime = 0;
    bgMusic.play();

    lastSpawnBulletTime = 0;
    lastSpawnPowerupTime = 0;
  }

  // End game logic
  function endGame() {
    isPaused = true;
    retryBtn.style.display = "inline-block";
    pauseBtn.style.display = "none";
    bgMusic.pause();

    if (score > highScore) {
      highScore = score;
      localStorage.setItem("highScore", highScore);
      alert(`New High Score: ${highScore}!`);
    } else {
      alert(`Game Over! Score: ${score}. High Score: ${highScore}`);
    }
  }

  // Game loop using requestAnimationFrame timestamp
  function gameLoop(timestamp) {
    if (!lastSpawnBulletTime) lastSpawnBulletTime = timestamp;
    if (!lastSpawnPowerupTime) lastSpawnPowerupTime = timestamp;

    if (!isPaused) {
      // Spawn bullets every ~600ms (faster with level)
      if (timestamp - lastSpawnBulletTime > Math.max(300, 800 - level * 20)) {
        spawnBullet();
        lastSpawnBulletTime = timestamp;
      }

      // Spawn powerups every 7-14 seconds
      if (timestamp - lastSpawnPowerupTime > 7000 + Math.random() * 7000) {
        spawnPowerup();
        lastSpawnPowerupTime = timestamp;
      }

      // Move bullets
      bullets.forEach((b, i) => {
        if (!freezeBulletsActive) b.y += bulletSpeed;
        b.el.style.top = b.y + "px";

        if (b.y > window.innerHeight) {
          b.el.remove();
          bullets.splice(i, 1);
          score += doublePointsActive ? 2 : 1;
          updateScore();
          if (score % 20 === 0) {
            level++;
            bulletSpeed += 0.5;
          }
        } else {
          const rocketRect = rocket.getBoundingClientRect();
          const bulletRect = b.el.getBoundingClientRect();
          if (rectsIntersect(rocketRect, bulletRect)) {
            if (shieldActive) {
              shieldActive = false;
              rocket.style.background = "red";
              showPowerupNotification("Shield Used!");
              b.el.remove();
              bullets.splice(i, 1);
              updateScore();
            } else {
              lives--;
              hitSound.play();
              updateScore();
              b.el.remove();
              bullets.splice(i, 1);
              if (lives <= 0) {
                endGame();
              }
            }
          }
        }
      });

      // Move powerups
      powerups.forEach((p, i) => {
        p.y += 2;
        p.el.style.top = p.y + "px";

        if (p.y > window.innerHeight) {
          p.el.remove();
          powerups.splice(i, 1);
        } else {
          const rocketRect = rocket.getBoundingClientRect();
          const powerupRect = p.el.getBoundingClientRect();
          if (rectsIntersect(rocketRect, powerupRect)) {
            const activated = p.type.activate();
            if (activated === true) {
              powerupActive = true;
            }
            p.el.remove();
            powerups.splice(i, 1);
          }
        }
      });

      // Move rocket if keys pressed
      const rocketLeft = rocket.offsetLeft;
      if (leftPressed && rocketLeft > 0) {
        rocket.style.left = rocketLeft - rocketSpeed + "px";
        createTrail();
      }
      if (rightPressed && rocketLeft < window.innerWidth - rocket.offsetWidth) {
        rocket.style.left = rocketLeft + rocketSpeed + "px";
        createTrail();
      }
    }

    requestAnimationFrame(gameLoop);
  }

  // Input handlers
  window.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") leftPressed = true;
    if (e.key === "ArrowRight") rightPressed = true;
  });
  window.addEventListener("keyup", e => {
    if (e.key === "ArrowLeft") leftPressed = false;
    if (e.key === "ArrowRight") rightPressed = false;
  });

  // Mobile button input
  const leftBtn = document.getElementById("leftBtn");
  const rightBtn = document.getElementById("rightBtn");

  leftBtn.addEventListener("touchstart", e => {
    e.preventDefault();
    leftPressed = true;
  });
  leftBtn.addEventListener("touchend", e => {
    e.preventDefault();
    leftPressed = false;
  });
  rightBtn.addEventListener("touchstart", e => {
    e.preventDefault();
    rightPressed = true;
  });
  rightBtn.addEventListener("touchend", e => {
    e.preventDefault();
    rightPressed = false;
  });

  // Retry button
  retryBtn.addEventListener("click", () => {
    resetGame();
  });

  // Pause button
  pauseBtn.addEventListener("click", () => {
    if (isPaused) {
      isPaused = false;
      pauseBtn.textContent = "Pause";
      bgMusic.play();
    } else {
      isPaused = true;
      pauseBtn.textContent = "Resume";
      bgMusic.pause();
    }
  });

  // Initialize
  rocket.style.left = (window.innerWidth / 2 - rocket.offsetWidth / 2) + "px";
  updateScore();
  bgMusic.volume = 0.2;
  bgMusic.play();

  requestAnimationFrame(gameLoop);
})();
</script>
</body>
</html>

